<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>RGCA Manuscript Pipeline • RGCA</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="RGCA Manuscript Pipeline">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RGCA</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/RGCA_manuscript.html">RGCA Manuscript Pipeline</a></li>
    <li><a class="dropdown-item" href="../articles/Simple_Application.html">Simple Application of RGCA</a></li>
  </ul>
</li>
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
<ul class="navbar-nav"></ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>RGCA Manuscript Pipeline</h1>
                        <h4 data-toc-skip class="author">Daniel
Zilber</h4>
            
      

      <div class="d-none name"><code>RGCA_manuscript.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-mixture-prediction-pipeline">The Mixture Prediction Pipeline<a class="anchor" aria-label="anchor" href="#the-mixture-prediction-pipeline"></a>
</h2>
<p>This script predicts a response to a mixture of chemicals given an
input data of individual dose responses and the concentrations of the
components of the mixture. The procedure followed in this pipeline is as
follows: 1. Load all inputs 2. Fit individual dose response curves 3.
Cluster the individual dose response slope parameters 4. Create a
collection of predictors (“calculators”) by sampling the slope cluster
and parameters 5. Given a mixture, predict a response with each
calculator. The plots show the 5, 50, and 95 percentile.</p>
<div class="section level3">
<h3 id="loading-data">Loading data<a class="anchor" aria-label="anchor" href="#loading-data"></a>
</h3>
<p>To start, we load the required packages, including RGCA, and some
auxiliary files for plotting and reading the Tox21 data. These are not
part of the package because they are specific to the manuscript.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape" class="external-link">reshape2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.r-project.org" class="external-link">drc</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: MASS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 'drc' has been loaded.</span></span>
<span><span class="co">#&gt; Please cite R and 'drc' if used for a publication,</span></span>
<span><span class="co">#&gt; for references type 'citation()' and 'citation('drc')'.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'drc'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     gaussian, getInitial</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org" class="external-link">readxl</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:MASS':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     select</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/FK83/scoringRules" class="external-link">scoringRules</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://niehs.github.io/RGCA/">RGCA</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">utils</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"../inst/manuscript_plots.R"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: plotly</span></span>
<span><span class="co">#&gt; Warning in library(package, lib.loc = lib.loc, character.only = TRUE,</span></span>
<span><span class="co">#&gt; logical.return = TRUE, : there is no package called 'plotly'</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"../inst/tox21_prep_data.R"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"../inst/helper_pipeline.R"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: coda</span></span>
<span><span class="co">#&gt; Warning in library(package, lib.loc = lib.loc, character.only = TRUE,</span></span>
<span><span class="co">#&gt; logical.return = TRUE, : there is no package called 'coda'</span></span>
<span><span class="co">#&gt; Loading required package: tables</span></span>
<span><span class="co">#&gt; Warning in library(package, lib.loc = lib.loc, character.only = TRUE,</span></span>
<span><span class="co">#&gt; logical.return = TRUE, : there is no package called 'tables'</span></span></code></pre></div>
<p>Next we read the prepared Tox21 data, which creates a series of
objects including the observed dose response
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">y_i</annotation></semantics></math>,
the concentration for the observed dose response
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">Cx</annotation></semantics></math>,
and a list to track which entries are replicates. Null values are
present in the data to indicate an anomalous response, such as cell
death. Some chemicals have 3 replicates and some have 6.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_df</span> <span class="op">&lt;-</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.delim</a></span><span class="op">(</span><span class="st">"../inst/extdata/AR-luc.txt"</span><span class="op">)</span></span>
<span><span class="va">mix_guide</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_xls</a></span><span class="op">(</span><span class="st">"../inst/extdata/AllMixtureComponentsARER.xls"</span><span class="op">)</span></span>
<span><span class="fu">read_prepared_Tox21_data</span><span class="op">(</span><span class="va">input_df</span>, <span class="va">mix_guide</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Observed response"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Observed response</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">y_i</span><span class="op">)</span></span>
<span><span class="co">#&gt;            [,1]       [,2]        [,3]       [,4]        [,5]       [,6]</span></span>
<span><span class="co">#&gt; [1,]  1.1826353  2.4826635  1.51578025  1.4892761  4.49209447  6.5474142</span></span>
<span><span class="co">#&gt; [2,] -0.6334479  0.9216168  0.60169789  2.0617608  1.33278993  0.9216314</span></span>
<span><span class="co">#&gt; [3,] -1.5807759  2.9179836  1.48661741 -0.8020371  0.06912863 -0.5359517</span></span>
<span><span class="co">#&gt; [4,]  1.3299733  1.1730434 -0.04242502  0.3463708  0.04687224  0.1058324</span></span>
<span><span class="co">#&gt; [5,]  0.1689624  1.1800216  0.77479527  0.4291119  0.99653685  0.3122312</span></span>
<span><span class="co">#&gt; [6,]  6.9164171 18.6521627 42.43889777 65.0567233 80.80913096 86.7305131</span></span>
<span><span class="co">#&gt;            [,7]       [,8]      [,9]      [,10]      [,11]     [,12]     [,13]</span></span>
<span><span class="co">#&gt; [1,] 10.0457328 19.4146939 33.582836 47.2007379 57.2383820 94.758215 80.468399</span></span>
<span><span class="co">#&gt; [2,]  1.0420852  1.4888338  1.244484  0.5806189 -0.8943978 -1.534201 -1.577272</span></span>
<span><span class="co">#&gt; [3,] -0.5994553  0.8354096  1.466298 -0.6603799 -0.5334993 -1.134656 -1.988023</span></span>
<span><span class="co">#&gt; [4,]  0.6155381  1.0922728  1.047398  0.3259035 -0.3445795 -1.629641 -4.327155</span></span>
<span><span class="co">#&gt; [5,]  3.1553595  0.8027576  3.766346  4.5388174 16.2244239 20.882732 37.762179</span></span>
<span><span class="co">#&gt; [6,] 81.7200304 84.0045972 86.404822 86.6209343 83.9145229 89.501855 90.271835</span></span>
<span><span class="co">#&gt;           [,14]     [,15]</span></span>
<span><span class="co">#&gt; [1,]         NA        NA</span></span>
<span><span class="co">#&gt; [2,]  -3.134762 -8.737393</span></span>
<span><span class="co">#&gt; [3,]  -1.853277 -4.499909</span></span>
<span><span class="co">#&gt; [4,]  -4.470151 -7.752958</span></span>
<span><span class="co">#&gt; [5,]         NA        NA</span></span>
<span><span class="co">#&gt; [6,] 106.733244        NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Concentration"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Concentration</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Cx</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] 1.174e-09 2.626e-09 5.871e-09 1.313e-08 2.935e-08 6.564e-08 1.468e-07</span></span>
<span><span class="co">#&gt; [2,] 1.125e-09 2.516e-09 5.626e-09 1.258e-08 2.813e-08 6.290e-08 1.407e-07</span></span>
<span><span class="co">#&gt; [3,] 1.169e-09 2.613e-09 5.843e-09 1.306e-08 2.921e-08 6.532e-08 1.461e-07</span></span>
<span><span class="co">#&gt; [4,] 1.039e-09 2.324e-09 5.197e-09 1.162e-08 2.598e-08 5.810e-08 1.299e-07</span></span>
<span><span class="co">#&gt; [5,] 1.200e-09 2.684e-09 6.001e-09 1.342e-08 3.001e-08 6.710e-08 1.500e-07</span></span>
<span><span class="co">#&gt; [6,] 1.189e-09 2.659e-09 5.945e-09 1.329e-08 2.972e-08 6.647e-08 1.486e-07</span></span>
<span><span class="co">#&gt;           [,8]      [,9]     [,10]     [,11]     [,12]     [,13]     [,14]</span></span>
<span><span class="co">#&gt; [1,] 3.282e-07 7.339e-07 1.641e-06 3.669e-06 8.205e-06 1.835e-05        NA</span></span>
<span><span class="co">#&gt; [2,] 3.145e-07 7.033e-07 1.573e-06 3.516e-06 7.863e-06 1.758e-05 3.931e-05</span></span>
<span><span class="co">#&gt; [3,] 3.266e-07 7.303e-07 1.633e-06 3.652e-06 8.165e-06 1.826e-05 4.083e-05</span></span>
<span><span class="co">#&gt; [4,] 2.905e-07 6.496e-07 1.453e-06 3.248e-06 7.263e-06 1.624e-05 3.631e-05</span></span>
<span><span class="co">#&gt; [5,] 3.355e-07 7.502e-07 1.677e-06 3.751e-06 8.387e-06 1.875e-05        NA</span></span>
<span><span class="co">#&gt; [6,] 3.323e-07 7.431e-07 1.662e-06 3.716e-06 8.308e-06 1.858e-05 4.154e-05</span></span>
<span><span class="co">#&gt;          [,15]</span></span>
<span><span class="co">#&gt; [1,]        NA</span></span>
<span><span class="co">#&gt; [2,] 8.791e-05</span></span>
<span><span class="co">#&gt; [3,] 9.129e-05</span></span>
<span><span class="co">#&gt; [4,] 8.120e-05</span></span>
<span><span class="co">#&gt; [5,]        NA</span></span>
<span><span class="co">#&gt; [6,]        NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Replicates by index"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Replicates by index</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">replicate_sets</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 23 44 53</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 14 18 30 46 50 67</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1]  9 36 51</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; [1]  4 41 61</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[5]]</span></span>
<span><span class="co">#&gt; [1]  2  7 26 34 60 62</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[6]]</span></span>
<span><span class="co">#&gt; [1]  6  8 24 42 49 55</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-dose-responses">Fitting Dose Responses<a class="anchor" aria-label="anchor" href="#fitting-dose-responses"></a>
</h3>
<p>A random effect model is fit to each chemical indexed by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>c</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>f</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>c</mi><mo stretchy="false" form="prefix">|</mo><msub><mi>a</mi><mi>i</mi></msub><mo>,</mo><msub><mi>θ</mi><mi>i</mi></msub><mo>,</mo><msub><mi>β</mi><mi>i</mi></msub><mo>,</mo><msub><mi>u</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>,</mo><msub><mi>v</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><msub><mi>a</mi><mi>i</mi></msub><mo>+</mo><msub><mi>u</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><mrow><mn>1</mn><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>θ</mi><mi>i</mi></msub><mi>c</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>β</mi><mi>i</mi></msub></msup></mrow></mfrac><mo>+</mo><msub><mi>v</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><msub><mi>ϵ</mi><mrow><mi>i</mi><mi>j</mi><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">  R_i(c) =f_i(c|a_i,\theta_i,\beta_i, u_{ij}, v_{ij}) =
\frac{a_i+u_{ij}}{1+\left(\frac{\theta_i}{c}\right)^{\beta_i}} + v_{ij} +
\epsilon_{ijc} </annotation></semantics></math> The MCMC script uses
standard methods.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">re_iter</span> <span class="op">&lt;-</span> <span class="fl">1e4</span> <span class="co">#for manuscript we use 2.5e4 = 25,000 iterations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">102</span><span class="op">)</span></span>
<span><span class="co"># fit random effects model</span></span>
<span><span class="va">re_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RE_MCMC_fit.html">RE_MCMC_fit</a></span><span class="op">(</span><span class="va">y_i</span>, <span class="va">Cx</span>, <span class="va">replicate_sets</span>, n_iter <span class="op">=</span> <span class="va">re_iter</span><span class="op">)</span></span></code></pre></div>
<p>The beginning 5000 iterations of the chains are removed and the
remaining iterations thinned. The thinned samples for relevant
parameters are then provided in a list for sampling downstream, or as
objects with the median parameters for methods that do not need
uncertainty quantification.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">re_par_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pull_parameters.html">pull_parameters</a></span><span class="op">(</span><span class="va">re_chains</span><span class="op">)</span></span>
<span><span class="co"># Pull RGCA MCMC parameters estimates without uncertainty</span></span>
<span><span class="va">re_par_summary</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/pull_summary_parameters.html">pull_summary_parameters</a></span><span class="op">(</span><span class="va">re_chains</span>, summry_stat <span class="op">=</span> <span class="va">median</span><span class="op">)</span></span>
<span><span class="co"># Collect the main parameters for clustering</span></span>
<span><span class="va">RE_curve_fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"sill"</span> <span class="op">=</span> <span class="va">re_par_summary</span><span class="op">$</span><span class="va">sill_params</span>,</span>
<span>  <span class="st">"ec50"</span> <span class="op">=</span> <span class="va">re_par_summary</span><span class="op">$</span><span class="va">ec50_params</span>,</span>
<span>  <span class="st">"slope"</span> <span class="op">=</span> <span class="va">re_par_summary</span><span class="op">$</span><span class="va">slope_params</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="clustering">Clustering<a class="anchor" aria-label="anchor" href="#clustering"></a>
</h3>
<p>Clustering is determined either randomly, by sign of the sill, or by
a K-means algorithm. First we generate some random clusters</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># RGCA + random sampling</span></span>
<span><span class="co"># create 20 random clusters: 1 GCA, 1 IA, and then 4x2,5x3,5x4,4x5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1331</span><span class="op">)</span></span>
<span><span class="va">rand_clust_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">18</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">18</span> <span class="op">*</span> <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">18</span> <span class="op">*</span> <span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">18</span> <span class="op">*</span> <span class="fl">30</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">18</span> <span class="op">*</span> <span class="fl">38</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fl">18</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">18</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">rand_clust_assign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">rand_clust_mat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># This naming approach sets the cluster assignment as a name to each entry, and</span></span>
<span><span class="co"># each entry is the weight of that assignment.  Using a vector of 1's implies</span></span>
<span><span class="co"># all clusterings are equally weighted.  This allows for the clustering to be</span></span>
<span><span class="co"># sampled if more bootstrapped samples are desired.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rand_clust_assign</span><span class="op">)</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">rand_clust_mat</span>,</span>
<span>        MARGIN <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">rx</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">paste</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">rx</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span><span class="op">)</span></span>
<span><span class="va">randclust_par_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"cluster_assign"</span> <span class="op">=</span> <span class="va">rand_clust_assign</span><span class="op">)</span></span>
<span><span class="co"># save a parameter list with the clustering and MCMC results from before</span></span>
<span><span class="va">RGCA_randclust_par_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">re_par_list</span>, <span class="va">randclust_par_list</span><span class="op">)</span></span></code></pre></div>
<p>We follow a similar procedure for the agonist-based (ie sill sign)
clustering.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">one_clust_assign</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">clust_by_agonist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_chems</span><span class="op">)</span></span>
<span><span class="va">clust_by_agonist</span><span class="op">[</span><span class="va">AR_agonist_rows</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">one_clust_assign</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">paste</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">clust_by_agonist</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">RGCA_ARER_clust_par_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"centers"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">re_par_summary</span><span class="op">$</span><span class="va">slope_params</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="st">"cluster_assign"</span> <span class="op">=</span> <span class="va">one_clust_assign</span>,</span>
<span>  <span class="st">"cent_sd"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_chems</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">RGCA_ARER_par_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">re_par_list</span>, <span class="va">RGCA_ARER_clust_par_list</span><span class="op">)</span></span></code></pre></div>
<p>and then for K-means clustering.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># RGCA using Kmeans: allow for 1 to 6 clusters</span></span>
<span><span class="va">kmeans_clust_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="fl">6</span>, ncol <span class="op">=</span> <span class="va">n_chems</span><span class="op">)</span></span>
<span><span class="co"># test 1 to 6 cluster centers</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">kmeans_clust_mat</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">RE_curve_fits</span>, <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">cluster</span></span>
<span>  <span class="co"># print the ratio of the between-set sum of squares and total to compare</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">RE_curve_fits</span>, <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">betweenss</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">RE_curve_fits</span>, <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">totss</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] -1.452624e-16</span></span>
<span><span class="co">#&gt; [1] 0.7180256</span></span>
<span><span class="co">#&gt; [1] 0.9227801</span></span>
<span><span class="co">#&gt; [1] 0.9460953</span></span>
<span><span class="co">#&gt; [1] 0.9490617</span></span>
<span><span class="co">#&gt; [1] 0.9509603</span></span>
<span><span class="va">kmeans_clust_assign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">kmeans_clust_mat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">kmeans_clust_assign</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">kmeans_clust_mat</span>,</span>
<span>                                    MARGIN <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                    FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">rx</span><span class="op">)</span> <span class="op">{</span></span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">paste</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">rx</span><span class="op">)</span><span class="op">)</span></span>
<span>                                    <span class="op">}</span><span class="op">)</span></span>
<span><span class="va">kmeans_clust_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"cluster_assign"</span> <span class="op">=</span> <span class="va">kmeans_clust_assign</span><span class="op">)</span></span>
<span><span class="co"># save a parameter list with the clustering and MCMC results from before</span></span>
<span><span class="va">RGCA_kmeansclust_par_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">re_par_list</span>, <span class="va">kmeans_clust_list</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="special-cases">Special cases<a class="anchor" aria-label="anchor" href="#special-cases"></a>
</h3>
<p>One of the special cases we test is to use the Reflected GCA but
without the clustering. Hence we create one large cluster (like GCA) and
keep the fitted slopes. Regular GCA must set the slope values to 1.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># RGCA alone ####</span></span>
<span><span class="va">one_clust_assign</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">one_clust_assign</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">paste</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_chems</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">RGCA_clust_par_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"centers"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">re_par_summary</span><span class="op">$</span><span class="va">slope_params</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="st">"cluster_assign"</span> <span class="op">=</span> <span class="va">one_clust_assign</span>,</span>
<span>  <span class="st">"cent_sd"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_chems</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">RGCA_par_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">re_par_list</span>, <span class="va">RGCA_clust_par_list</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="creating-calculators">Creating Calculators<a class="anchor" aria-label="anchor" href="#creating-calculators"></a>
</h3>
<p>After all the parameter settings are established, we can generate the
calculator functions that take as input the doses for the various
chemicals and output a predicted response. For the methods with
uncertainty quantification, we bootstrap the calculators by using the
function “create_mix_calc,” which will take a sample from the MCMC
posterior.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1026</span><span class="op">)</span></span>
<span><span class="co"># Random cluster calculators</span></span>
<span><span class="va">n_bootstraps</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">random_clustered_RGCA</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_bootstraps</span>,</span>
<span>         FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>           <span class="fu"><a href="../reference/create_mix_calc.html">create_mix_calc</a></span><span class="op">(</span><span class="va">x</span>,</span>
<span>                           <span class="va">RGCA_randclust_par_list</span>,</span>
<span>                           add_RE <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>         <span class="op">}</span><span class="op">)</span></span>
<span><span class="co"># KMeans clustering calculator</span></span>
<span><span class="va">kmeans_samp_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, size <span class="op">=</span> <span class="va">n_bootstraps</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">sampled_kmeans_clustered_RGCA</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">kmeans_samp_idx</span>,</span>
<span>         FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>           <span class="fu"><a href="../reference/create_mix_calc.html">create_mix_calc</a></span><span class="op">(</span><span class="va">x</span>,</span>
<span>                           <span class="va">RGCA_kmeansclust_par_list</span>,</span>
<span>                           add_RE <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>         <span class="op">}</span><span class="op">)</span></span>
<span><span class="co"># No cluster (pure RGCA) calculator</span></span>
<span><span class="va">sampled_mix_funs_RGCA</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_bootstraps</span><span class="op">)</span>,</span>
<span>         FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>           <span class="fu"><a href="../reference/create_mix_calc.html">create_mix_calc</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">RGCA_par_list</span>, add_RE <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>         <span class="op">}</span><span class="op">)</span></span>
<span><span class="co"># Sill clustered calculator</span></span>
<span><span class="va">sampled_mix_funs_RGCA_ARER</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_bootstraps</span><span class="op">)</span>,</span>
<span>         FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>           <span class="fu"><a href="../reference/create_mix_calc.html">create_mix_calc</a></span><span class="op">(</span><span class="va">x</span>,</span>
<span>                           <span class="va">RGCA_ARER_par_list</span>,</span>
<span>                           add_RE <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>         <span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="standard-methods-ia-and-gca">Standard Methods: IA and GCA<a class="anchor" aria-label="anchor" href="#standard-methods-ia-and-gca"></a>
</h3>
<p>GCA fixes the slope parameters to 1, but we want to allow the other
parameters to adjust to that constraint so we rerun the MCMC algorithm
with the slope fixed to 1.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1025</span><span class="op">)</span></span>
<span><span class="co"># specify the MCMC to fit 2 - parameter Hill models for GCA</span></span>
<span><span class="va">re_chains_2param</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/RE_MCMC_fit.html">RE_MCMC_fit</a></span><span class="op">(</span><span class="va">y_i</span>,</span>
<span>              <span class="va">Cx</span>,</span>
<span>              <span class="va">replicate_sets</span>,</span>
<span>              n_iter <span class="op">=</span> <span class="va">re_iter</span>,</span>
<span>              n_hill_par <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">re_2par_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pull_parameters.html">pull_parameters</a></span><span class="op">(</span><span class="va">re_chains_2param</span><span class="op">)</span></span>
<span><span class="co"># Pull parameter estimates without uncertainty</span></span>
<span><span class="va">re_2par_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pull_summary_parameters.html">pull_summary_parameters</a></span><span class="op">(</span><span class="va">re_chains_2param</span><span class="op">)</span></span></code></pre></div>
<p>We now make the parameter lists for the simpler Independent Action
(IA) and regular GCA models. IA uses the parameter estimates from the
RGCA MCMC fit. Neither IA nor GCA nor CA takes advantage of the
uncertainty; this is to demonstrate the utility of the Bayesian method,
but in principle they can all be resampled like RGCA to generate
credible intervals.</p>
<p>First, we finish with GCA and then create the calculator for CA,
which requires the sill parameter to be equal across all chemicals.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># GCA single calculator: first create the parameter specification</span></span>
<span><span class="va">GCA_assign</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">GCA_assign</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">paste</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_chems</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">GCA_assign_vec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">GCA_assign</span><span class="op">)</span>, split <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">param_matrix_GCA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>    <span class="st">"a"</span> <span class="op">=</span> <span class="va">re_2par_summary</span><span class="op">$</span><span class="va">sill_params</span>,</span>
<span>    <span class="st">"b"</span> <span class="op">=</span> <span class="va">re_2par_summary</span><span class="op">$</span><span class="va">ec50_params</span>,</span>
<span>    <span class="st">"c"</span> <span class="op">=</span> <span class="va">re_2par_summary</span><span class="op">$</span><span class="va">slope_params</span>,</span>
<span>    <span class="st">"max_R"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">re_par_summary</span><span class="op">$</span><span class="va">sill_params</span><span class="op">)</span>,</span>
<span>    <span class="st">"d"</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Next use the parameters to instantiate the predictive calculator</span></span>
<span><span class="va">GCA_calculator</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/mix_function_generator.html">mix_function_generator</a></span><span class="op">(</span><span class="va">param_matrix_GCA</span>, <span class="va">GCA_assign_vec</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CA single calculator ####</span></span>
<span><span class="va">param_matrix_CA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>    <span class="st">"a"</span> <span class="op">=</span> <span class="va">re_par_summary</span><span class="op">$</span><span class="va">sill_params</span>,</span>
<span>    <span class="st">"b"</span> <span class="op">=</span> <span class="va">re_par_summary</span><span class="op">$</span><span class="va">ec50_params</span>,</span>
<span>    <span class="st">"c"</span> <span class="op">=</span> <span class="va">re_par_summary</span><span class="op">$</span><span class="va">slope_params</span>,</span>
<span>    <span class="st">"max_R"</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    <span class="st">"d"</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># simple CA calculator:  force all sill params to be equal</span></span>
<span><span class="va">CA_calculator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mix_function_generator.html">mix_function_generator</a></span><span class="op">(</span><span class="va">param_matrix_CA</span>,</span>
<span>                                        <span class="va">GCA_assign_vec</span>,</span>
<span>                                        scale_CA <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Next we create the calculator for IA.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#  IA single assignment, all chemicals are separate</span></span>
<span><span class="va">IA_assign</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">IA_assign</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">paste</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_chems</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">IA_assign_vec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">IA_assign</span><span class="op">)</span>, split <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">param_matrix_IA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>    <span class="st">"a"</span> <span class="op">=</span> <span class="va">re_par_summary</span><span class="op">$</span><span class="va">sill_params</span>,</span>
<span>    <span class="st">"b"</span> <span class="op">=</span> <span class="va">re_par_summary</span><span class="op">$</span><span class="va">ec50_params</span>,</span>
<span>    <span class="st">"c"</span> <span class="op">=</span> <span class="va">re_par_summary</span><span class="op">$</span><span class="va">slope_params</span>,</span>
<span>    <span class="st">"max_R"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">re_par_summary</span><span class="op">$</span><span class="va">sill_params</span><span class="op">)</span>,</span>
<span>    <span class="st">"d"</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># build the calculator to predict a response given a dose vector</span></span>
<span><span class="va">IA_calculator</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/mix_function_generator.html">mix_function_generator</a></span><span class="op">(</span><span class="va">param_matrix_IA</span>, <span class="va">IA_assign_vec</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="calculator-set">Calculator Set<a class="anchor" aria-label="anchor" href="#calculator-set"></a>
</h3>
<p>We can collect the calculators into a list, commenting out
calculators as desired to have less cluttered plots. Note</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># select which methods to use for prediction and plotting</span></span>
<span><span class="va">bootstrap_calc_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"RGCA"</span> <span class="op">=</span> <span class="va">sampled_mix_funs_RGCA</span>,</span>
<span>  <span class="st">"RGCA_MOA"</span> <span class="op">=</span> <span class="va">sampled_mix_funs_RGCA_ARER</span>,</span>
<span>  <span class="st">"RGCA_kMeans"</span> <span class="op">=</span> <span class="va">sampled_kmeans_clustered_RGCA</span>,</span>
<span>  <span class="st">"Random_RGCA"</span> <span class="op">=</span> <span class="va">random_clustered_RGCA</span>,</span>
<span>  <span class="st">"GCA"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">GCA_calculator</span><span class="op">)</span>,</span>
<span>  <span class="st">"IA"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">IA_calculator</span><span class="op">)</span>,</span>
<span>  <span class="st">"CA"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">CA_calculator</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>##Predicting Mixture responses</p>
<p>Before proceeding with actual mixtures, we can check that sham
mixtures with only one chemical are correctly modeled.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_dummy_mixture</span><span class="op">(</span><span class="va">Cx</span>, <span class="va">y_i</span>, <span class="va">tot_par_list</span>, <span class="va">replicate_sets</span>,</span>
<span>                   <span class="va">bootstrap_calc_list</span>, test_idx <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p><img src="RGCA_manuscript_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Now we can proceed to predicting with the actual data. The sets of
indices are chosen based on the descriptions of the mixtures. This part
is solving the two-step model with the bootstrapped calculators built on
our fitted parameters and clustering, and can take a few minutes per
mixture</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># all mixtures where the Estrogen Receptor agonists are at 4x their fitted EC50</span></span>
<span><span class="va">set_4x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">12</span>, <span class="fl">20</span>, <span class="fl">29</span>, <span class="fl">43</span>, <span class="fl">52</span>, <span class="fl">55</span>, <span class="fl">57</span><span class="op">)</span></span>
<span><span class="co"># mixtures from set_4x plus all other mixtures with all chemicals or all</span></span>
<span><span class="co"># Androgen receptor agonists present</span></span>
<span><span class="va">set_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">12</span>, <span class="fl">20</span>, <span class="fl">25</span>, <span class="fl">29</span>, <span class="fl">30</span>, <span class="fl">31</span>, <span class="fl">32</span>, <span class="fl">43</span>, <span class="fl">45</span>, <span class="fl">50</span>, <span class="fl">52</span>, <span class="fl">55</span>, <span class="fl">57</span>, <span class="fl">62</span><span class="op">)</span></span>
<span><span class="co"># a single index for testing</span></span>
<span><span class="va">mix_idx</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="co"># choose one! 16, 8, 27</span></span>
<span><span class="co"># a sampling of mixtures with only two components</span></span>
<span><span class="va">binary_mixes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">34</span>, <span class="fl">37</span>, <span class="fl">61</span><span class="op">)</span></span>
<span><span class="co"># a sampling of chemicals with 3-5 components</span></span>
<span><span class="va">small_mixes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">26</span>, <span class="fl">47</span><span class="op">)</span></span>
<span><span class="co"># just plot one index for demonstration</span></span>
<span><span class="va">score_matrix</span> <span class="op">&lt;-</span> <span class="fu">plot_mixture_response</span><span class="op">(</span><span class="va">mix_idx</span>, <span class="va">mix_df</span>, <span class="va">mix_conc_df</span>, <span class="va">mix_guide</span>,</span>
<span>                                      <span class="va">bootstrap_calc_list</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">shape</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">shape</span>, which will replace the existing scale.</span></span></code></pre></div>
<p><img src="RGCA_manuscript_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>Finally, we format the score matrix and plot the results of the score
comparisons. Since this demonstration only runs one mixture by default,
the violin plots appear as lines.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">score_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">score_matrix</span><span class="op">)</span></span>
<span><span class="co"># drop rows of 0, in case some mixtures were skipped</span></span>
<span><span class="va">score_df</span> <span class="op">&lt;-</span> <span class="va">score_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">score_df</span>,</span>
<span>                           MARGIN <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                           FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">rx</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">rx</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Mix id"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bootstrap_calc_list</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LLH"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bootstrap_calc_list</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MSE"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bootstrap_calc_list</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CRPS"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Violin Plot for Scores ####</span></span>
<span><span class="fu">plot_scores</span><span class="op">(</span><span class="va">score_df</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">bootstrap_calc_list</span><span class="op">)</span></span>
<span><span class="co">#&gt; No id variables; using all as measure variables</span></span>
<span><span class="co">#&gt; No id variables; using all as measure variables</span></span>
<span><span class="co">#&gt; No id variables; using all as measure variables</span></span></code></pre></div>
<p><img src="RGCA_manuscript_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel Zilber, Kyle Messier.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
